{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Primary system integration with CARA","text":"<p>Note</p> <p>10.06.2025 ATNA IP changed for eprik-cara, it is now 83.228.201.24 (or atna.test.ahdis.ch)</p> <p>22.9.2023 Release  5.0.2: No changes in API </p> <p>29.3.2023: Release 5.0.0 on CARA INT: The EPR CARA integration version is newer than the production version, see changelog for differences.</p> <p>This documentation describes how the Integration Kit can be used to test the integration of a primary system with the CARA integration system.</p> <p>CARA offers different services:</p> <ul> <li>EPR https://epr.cara.int.post-ehealth.ch</li> <li>Transferts https://b2b.cara.int.post-ehealth.ch/.</li> <li>PMP (eMedication   Service) https://cara-ch.github.io/emed-service-guide/</li> </ul> <p>To access the integration system you will need to sign a contract/CGUE with CARA and provide an OID concept for your organization, in return you will get:</p> <ul> <li>an HCP test user for which you need an online authentication yourself (e.g. HIN ID) and connect that HCP test user   with your online authentication</li> <li>two test patients for you with patient access, public test patients are listed here</li> <li>access to the Post E-Health Platform \u2013 developer portal for the EPR   integration.</li> </ul> <p>This will allow you to start the integration of the primary system.</p> <p>The Integration Kit (short EPRIK) provides the following functionality:</p> <ul> <li>Authenticate an User and obtain an IdP assertion</li> <li>Proxy and log IHE transactions without client certificates and with basic validation of request / response</li> </ul> <p> </p> Integration architecture <p>This allows a primary system to do a stepwise integration. The integration kit is only an add-on during development, testing and CANNOT BE used with a production environment.</p> <p>Danger</p> <p>Use only test data and no real patient data! EPRIK is completely open  and every request / response to the integration system made is retrievable.</p>"},{"location":"#testing-the-tls-connection-with-cara-int","title":"Testing the TLS connection with CARA INT","text":"<p>There are two different TLS connections with CARA INT you can test: the Syslog connection (to send ATNA messages)  and the webservices connection (to send IHE requests).</p> <p>In these tests, you have to use your own certificate and private key. Note that they may be stored in the same .pem file.</p>"},{"location":"#syslog-connection","title":"Syslog connection","text":"<p>You can test the Syslog connection with <code>openssl</code>: <pre><code>openssl s_client -connect syslog-int.post-ehealth.ch:7003 -cert cert.pem -key private_key.pem\n</code></pre></p> <p>In case of success, you will see \"read R BLOCK\" as last line of the output, and you should be able to send data in  the connection (the command should not have returned).</p> <p>If the command returns, and/or the last output line is \"closed\", then the connection failed. In case of error, you can increase the log levels with the parameters <code>-state -debug -msg -prexit</code>.</p>"},{"location":"#webservices-connection","title":"Webservices connection","text":"<p>You can test the webservices connection with <code>curl</code>: <pre><code>curl --cert cert.pem --key private_key.pem https://ws.epr.cara.int.post-ehealth.ch:443\n</code></pre></p> <p>In case of success, you will see the content of the \"HTTP 404 - Not Found\" page of the Post. In case of error, you may see an error like \"curl: (56) OpenSSL SSL_read: error:14094410:SSL  routines:ssl3_read_bytes:sslv3 alert handshake failure, errno 0\".</p> <p>Warning</p> <p>We had errors testing the Webservices connection with <code>openssl</code>, although it is working fine for the Syslog  connection at the same time.</p>"},{"location":"changelog/","title":"CARA INT Changelog","text":""},{"location":"changelog/#11102024-release-600-on-cara-int","title":"11.10.2024: Release 6.0.0 on CARA INT","text":"<p>The integration system has been updated to 6.0.0 from 5.0.0 with the following changes:</p> <ul> <li>STS: the <code>sha1</code> signature algorithm is no longer supported. Use the <code>sha256</code> algorithm instead.   The <code>sha1</code> digest algorithm is still supported, but you should migrate to <code>sha256</code> too.</li> </ul>"},{"location":"changelog/#2932023-release-500-on-cara-int","title":"29.3.2023: Release 5.0.0 on CARA INT","text":"<p>The integration system has been updated to 5.0.0 from 3.7.0 with the following changes:</p> <ul> <li>STS: endpoint for the Secure Token Service has been changed from 5.0.0 from /EPDSTS/services/SecurityTokenService to   /STS/services/SecurityTokenService</li> <li>ITI-41: Document Entry.originalProviderRole needs to be   provided EPDREL 15: Annex 5, E1</li> <li>ITI-45: For a PIX V3 query where the EPR-SPID is requested, the EPR-PID will be returned in patient/id (before   patient/patientPerson/asOtherIDs/id) EPDREL 16: Annex 5, E1. </li> </ul>"},{"location":"changelog_eprik/","title":"EPRIK Changelog","text":""},{"location":"changelog_eprik/#version-1211-06092024","title":"Version 1.2.11 - 06/09/2024","text":"<ul> <li>Made the recipient list load faster.</li> <li>Improved the settings page.</li> <li>Clarified wordings in the transaction details page.</li> <li>Fixed the line numbering in the code editor, when a jump is performed.</li> <li>Improved the display of info messages in the code editor.</li> </ul>"},{"location":"changelog_eprik/#version-1210-13062024","title":"Version 1.2.10 - 13/06/2024","text":"<ul> <li>Fixed display of binary data when the multipart boundary is not found #107.</li> <li>Added a warning in the message validation when the external validation is disabled #108.</li> <li>Fixed various small issues in the frontend.</li> </ul>"},{"location":"changelog_eprik/#version-129-11062024","title":"Version 1.2.9 - 11/06/2024","text":"<ul> <li>Upgraded to Java 21 LTS.</li> <li>The content search now also searches in the message headers #99.</li> <li>Implemented the search by recipient #102.</li> <li>Handled error when parsing the boundary in multipart messages #100.</li> <li>Fixed a display issue in the transaction list for retina displays #106.</li> <li>Fixed validation of RegistryError.location #91.</li> <li>Implemented control of external validation by client, with automatic disabling after 8 hours #101.</li> </ul>"},{"location":"changelog_eprik/#version-128-08032024","title":"Version 1.2.8 - 08/03/2024","text":"<ul> <li>Added validation of ITI-45 PIXv3 queries.</li> <li>Downgraded the validation error when PIX Feeding with an AHV-number to a warning #86.</li> <li>Added a filter feature to search in requests and responses #39.</li> </ul>"},{"location":"changelog_eprik/#version-127-28022024","title":"Version 1.2.7 - 28/02/2024","text":"<ul> <li>Fixed connection with TrustID.</li> <li>Fixed an issue where the validation would not run anymore (again).</li> <li>Added milliseconds to the transaction details.</li> <li>Uniformized the validator names.</li> <li>Improved the exception messages when the Gazelle validator is not available.</li> <li>Fix overflow in validation results.</li> <li>Added simple validation of CH:XUA assertions.</li> </ul>"},{"location":"changelog_eprik/#version-126-15022024","title":"Version 1.2.6 - 15/02/2024","text":"<ul> <li>Fixed code not displayed in Safari.</li> <li>Hidden large binary blobs in the request and response.</li> <li>Fixed the code auto-format switching.</li> </ul>"},{"location":"changelog_eprik/#version-125-13022024","title":"Version 1.2.5 - 13/02/2024","text":"<ul> <li>Fixed display of binary data.</li> <li>Improved performance of the frontend (again).</li> <li>Added validation to authorInstitution in ITI-41 transactions.</li> </ul>"},{"location":"changelog_eprik/#version-124-22012024","title":"Version 1.2.4 - 22/01/2024","text":"<ul> <li>Improved performance of the frontend.</li> <li>Improved the transaction validation display.</li> <li>Updated the IDP icons.</li> <li>Fixed an issue where the validation would not be run anymore.</li> </ul>"},{"location":"changelog_eprik/#version-123-29112023","title":"Version 1.2.3 - 29/11/2023","text":"<ul> <li>Implemented line numbering in highlighted codes.</li> <li>Clients are now sorted by prefix in the list.</li> <li>Validators don't stop anymore at the first error.</li> <li>Added message for known issues with validators (IPF and EVSClient).</li> </ul>"},{"location":"changelog_eprik/#version-122-24112023","title":"Version 1.2.2 - 24/11/2023","text":"<ul> <li>Fixed message content processing, where binary data in multipart messages would be corrupted.</li> <li>Minor frontend improvements.</li> </ul>"},{"location":"changelog_eprik/#version-121-23112023","title":"Version 1.2.1 - 23/11/2023","text":"<ul> <li>Fixed error message in MTOM validation.</li> <li>Improved error messages in ATNA validation.</li> <li>Added pagination to results.</li> <li>Only showing runtime status if error, or request and response statuses in the transaction list.</li> <li>When clicking the status in the transaction list (e.g. \"response\" or \"runtime\"), the right tab will open.</li> <li>Increased effort to match audit messages to their client.</li> </ul>"},{"location":"changelog_eprik/#version-120-22112023","title":"Version 1.2.0 - 22/11/2023","text":"<ul> <li>A changelog is now published.</li> <li>Frontend redesign:<ul> <li>The code editor has been replaced with a simpler syntax highlighter, that should be lighter for the browser; the   native search function is not high-jacked anymore.</li> <li>The search API now returns fewer data, making the response smaller.</li> <li>There is now a minimal screen width needed for proper display.</li> </ul> </li> <li>The ITI-81 response validator is disabled because the CARA INT response still is at FHIR R3 version.</li> <li>The EVSClient validator of STS transactions has been fixed.</li> <li>The ITI-41 and ITI-43 requests are checked for valid MTOM use.</li> <li>The ITI-41 requests are checked for valid XOP use.</li> <li>The ATNA audit message validation has been improved.</li> <li>The client deletion has been fixed.</li> <li>The recipient is now filled on ATNA audit messages.</li> </ul>"},{"location":"eprik-config/","title":"EPRIK Configuration","text":"<p>The EPR Integration Kit is available at https://test.ahdis.ch/eprik-cara/.</p> <p> </p> Transaction List <p>By default it lists all transactions made during the day. You can filter by IHE transaction type or time range.</p>"},{"location":"eprik-config/#epr-endpoints","title":"EPR Endpoints","text":"<p>That the requests are routed through EPRIK the following endpoints need to be configured in your primary system for EPRIK instead of CARA INT for an EPR integration:</p> Transaction EPRIK Host test.ahdis.ch Port 443 (https) or 80 (http) XDS [ITI-18] /eprik-cara/camel/cara/Registry/services/RegistryService XDS [ITI-18] Initiating Gateway /eprik-cara/camel/cara/XCA/services/InitiatingGatewayService XDS [ITI-41] /eprik-cara/camel/cara/Repository/services/RepositoryService XDS [ITI-43] /eprik-cara/camel/cara/Repository/services/RepositoryService XDS [ITI-43] Initiating Gateway /eprik-cara/camel/XCA/services/InitiatingGatewayService XDS MU [ITI-57] /eprik-cara/camel/cara/Registry/services/RegistryService XDS RMU [ITI-92] /eprik-cara/camel/cara/Registry/services/RegistryService XDS-I RAD [ITI-69] /eprik-cara/camel/cara/Repository/services/RepositoryService PIX V3 [ITI-44] /eprik-cara/camel/cara/UPIProxy/services/PIXPDQV3ManagerService PIX V3 [ITI-45] /eprik-cara/camel/cara/UPIProxy/services/PIXPDQV3ManagerService PDQ V3 [ITI-47] /eprik-cara/camel/cara/UPIProxy/services/PIXPDQV3ManagerService HPD [ITI-58] /eprik-cara/camel/cara/HPD/services/HPDService HPD [ITI-59] /eprik-cara/camel/cara/HPD/services/HPDService CH:PPQ [PPQ-1] /eprik-cara/camel/cara/HPD/services/PR CH:PPQ [PPQ-2] /eprik-cara/camel/cara/HPD/services/PR XUA [ITI-40] /eprik-cara/camel/cara/STS/services/SecurityTokenService TCU SAML2 /eprik-cara/camel/tcu ATC [ITI-81] /eprik-cara/camel/cara/ARR/fhir/AuditEvent ATNA [ITI-20] atna.test.ahdis.ch:8080 or :80 (currently 37.156.40.86) unsecured TCP according to RFC5425 SVS [ITI-48] /eprik-cara/camel/cara/ValueSetRepository/services/ValueSetRepositoryService SVS [ITI-60] /eprik-cara/camel/cara/ValueSetRepository/services/ValueSetRepositoryService <p>You find an overview of the current relevant specifications and the associated links for the Swiss Electronic Patient Record EPR also here and in the Post E-Health Platform \u2013 developer portal.</p>"},{"location":"eprik-config/#transferts-tra-endpoints","title":"transferts (TRA) Endpoints","text":"<p>That the requests are routed through EPRIK the following endpoints need to be configured in your primary system for EPRIK instead of CARA INT for an transferts integration:</p> Transaction EPRIK Host test.ahdis.ch Port 443 (https) or 80 (http) TRA PIX V3 [ITI-44] /eprik-cara/camel/tra/PIXPDQ/services/PIXPDQV3ManagerService TRA PIX V3 [ITI-45] /eprik-cara/camel/tra/PIXPDQ/services/PIXPDQV3ManagerService TRA HPD [ITI-58] /eprik-cara/camel/tra/HPD/services/HPDService/ TRA HPD [ITI-59] /eprik-cara/camel/tra/HPD/services/HPDService/ TRA STS [ITI-40] /eprik-cara/camel/tra/b2bsts/SecurityTokenService/ TRA TCU STS /eprik-cara/camel/tra/2000040030829 TRA submitDocuments* /eprik-cara/camel/tra/rcdc/SourceAdaptor/ TRA GetDocumentList* /eprik-cara/camel/tra/rcdc/Rcdc/ TRA XDS [ITI-18]* /eprik-cara/camel/tra/Registry/services/RegistryService TRA XDS [ITI-41]* /eprik-cara/camel/tra/Repository/services/RepositoryService <ul> <li>Webservice call needs STS token</li> </ul>"},{"location":"eprik-config/#pmp-endpoints","title":"PMP Endpoints","text":"<p>That the requests are routed through EPRIK the following endpoints need to be configured in your primary system for EPRIK instead of CARA INT for a PMP integration for the following XDS transactions:</p> Transaction EPRIK Host test.ahdis.ch Port 443 (https) or 80 (http) XDS [ITI-18] /eprik-cara/camel/pmp-int/pmp/services/xds/iti18 XDS [ITI-41] /eprik-cara/camel/pmp-int/pmp/services/xds/iti41 XDS [ITI-43] /eprik-cara/camel/pmp-int/pmp/services/xds/iti43 XDS MU [ITI-57] /eprik-cara/camel/pmp-int/pmp/services/xds/iti57 CMPD [PHARM-1] /eprik-cara/camel/pmp-int/pmp/services/cmpd/chpharm1 <p>The other PMP host is available at the path <code>/eprik-cara/camel/pmp-dev/pmp/...</code>; see  https://cara-ch.github.io/emed-service-guide/endpoints/ for more details.</p>"},{"location":"eprik-config/#external-validation","title":"External validation","text":"<p>The EPRIK can use the Swiss EVS Client validator to validate various transactions and resources (like XUA assertions  and ATNA messages). Due to limited resources and rate limiting, the external validation is disabled by default. You  can enable it for a specific client in the Clients table. It will stay enabled for 8 hours and will be disabled  automatically.</p> <p>If the external validation is not enabled, a warning will be shown in the Validation part of the transaction details.</p>"},{"location":"faq/","title":"FAQ","text":""},{"location":"faq/#faq-integration-requests","title":"FAQ Integration Requests","text":""},{"location":"faq/#http-error-code-202-for-soap-request-eg-iti-18","title":"HTTP Error code 202 for SOAP Request (e.g. ITI-18)","text":"<p>check that in the SOAP WS:Header the <code>&lt;Address&gt;</code> element is in the same nampespace as the <code>&lt;ReplyTo&gt;</code> Element:</p> <pre><code>&lt;a:ReplyTo s:mustUnderstand=\"true\" xmlns:a=\"http://www.w3.org/2005/08/addressing\"&gt;\n&lt;a:Address&gt;http://www.w3.org/2005/08/addressing/anonymous&lt;/a:Address&gt;\n&lt;/a:ReplyTo&gt;\n</code></pre>"},{"location":"faq/#content-type-returned-not-multipartrelated-but-applicationxml","title":"Content-Type returned not multipart/related but application/xml","text":"<p>ITI-TF says that one should use multipart/related, see ITI-43 \u00a73.43.5.1.1.1, verify that you have <code>start-info=\"application/soap+xml; charset=utf-8\"</code> (or no <code>start-info</code>).</p> <p>e.g:</p> <pre><code>Content-Type: multipart/related; boundary=\"uuid:f42c35e4-54b2-45ca-8fda-ed58b11f6fce\";type=\"application/xop+xml\"; start=\" &lt;root.message@cxf.apache.org&gt;\";start-info=\"application/soap+xml; charset=utf-8\"\n</code></pre> <p>Please check also that the <code>&lt;xop:Include&gt;</code> has no whitespace/linebreaks before or after the tag source, with linebreaks you get an HTTP 500 error (currently the EPR Integration kit shows it all the time wrapped, verify it with download request).</p>"},{"location":"faq/#sts-error-500-with-tcu","title":"STS error 500 with TCU","text":"<p>if some STS TCU requests work and some not, check that you are in sync with the NTP time server, even below second differences can provoke that the assertion could be in the future for the STS (notBefore element, see issue)</p> <p>check also that you have no xml comments in request</p>"},{"location":"faq/#iti-41-http-error-code-500-soapbody-no-line-breaks-in-requests","title":"ITI-41: HTTP Error code 500 (soap:body no line breaks in requests)","text":"<p>2024-04-25: if the soap body is formatted with line breaks in the request, the request will not go through the back end (warning: empty request) and an http error 500 is returned, see xop:include comment above</p>"},{"location":"faq/#iti-45-no-mpi-pid-in-iti-45-response-if-queried-with-ahvn13","title":"ITI-45: No MPI-PID in ITI-45 response if queried with AHVN13","text":"<p>This is a data problem. Multiple local patients were either automatically or manually merged into the same master patient.</p>"},{"location":"faq/#iti-45iti-47-no-patient-data-returned","title":"ITI-45/ITI-47: No Patient data returned","text":"<p>Verify that the receiver id in the hl7 v3 message contains the oid for the integration system ( 2.16.756.5.30.1.191.1.0.12.1.101.2). You can also try to change the receiver OID to a random OID; if the patient data is returned, then someone fed a bad identifier to the patient and CARA needs to clean it manually.</p>"},{"location":"faq/#idp-hin-id","title":"IdP HIN ID","text":"<ol> <li>you need to have a GLN assigned to the HIN user that, otherwise the STS [ITI-40] will not work since the NameID is    not known</li> <li>the test HIN ID expires after six months</li> </ol>"},{"location":"faq/#idp-trust-id","title":"IdP TRUST ID","text":"<ol> <li>if you authenticate with trust ID and eprik you have to provide the SAML2 NameID to be configured</li> <li>you can get test trust id here and manage    it here</li> </ol>"},{"location":"faq/#verify-if-tcu-certificate-is-correctly-installed","title":"Verify if TCU certificate is correctly installed","text":"<p>for the STS request the public certificate is added in the <code>&lt;ds:X509Certificate&gt;</code> in the <code>&lt;saml2:Assertion&gt;</code>. You can get the fingerprint of it copying the content of the <code>&lt;ds:X509Certificate&gt;</code> into the echo '' part:</p> <pre><code>echo 'MII... =' | base64 -d | openssl x509 -noout -text -fingerprint -sha1\n</code></pre> <p>The resulting sha1 Fingerprint=73:85:78:C8:C8:0C:DE:5D:7A:3E:06:38:6B:80:6E:65:47:FB:61:18 can be checked in the cara admin portal if the certificate is available there. For the STS request it is important that the oid attributed to the user/certificate (showing in parentheses) in also added in the STS request in the <code>&lt;saml2:NameID&gt;</code>.</p>"},{"location":"pmp/","title":"CARA\u2019s eMedication service (PMP)","text":"<p>See CARA's eMedication IG.</p> <p>You can access any logs also directly at https://ws-pmp-int.cara.ch/pmp/mhd/logs.</p>"},{"location":"pmp/#eprik-integration-with-pmp","title":"eprik integration with pmp","text":"<ol> <li>Document query for a patient    via ITI-18 example</li> <li>MedicationList for a patient    via CH:PHARM1 example    and ITI-43 example</li> <li>Medication Card for a patient    via CH:PHARM1 example    and ITI-43 example</li> <li>Publication of a MTP document via    TCU ITI-41 example </li> </ol>"},{"location":"primarysystems-epr/","title":"EPR Primary System Integration","text":"<p>For a deep EPR integration into a primary systems the following usecases should be covered</p> <ol> <li>Integrate the strong authentication into the primary system with an IdP (Level 1)</li> <li>Search for patients in the community (Level 2.1)</li> <li>Register a patient from the primary system in the community (Level 2.1)</li> <li>Query and retrieve documents for a patient from the EPR including authorization (Level 2.2)</li> <li>Publish documents for a patient by a healthcare professional (Level 2.2)</li> <li>Providing AuditEvents (Level 2.1)</li> <li>Query and update the Healthcare Professional Directory (HPD) (Level 2.3)</li> <li>OID configuration</li> </ol> <p>The levels of integration are described by eHealth Suisse, see checklist [fr] and [de].</p> <p>eHealth Suisse has described the different steps with examples [fr], [de].</p> <p>You find test patients which you can use for publication of documents here.</p> <p>Please find below additional information relevant for CARA and EPRIK:</p>"},{"location":"primarysystems-epr/#1-integrate-the-strong-authentication-into-the-primary-system-with-and-idp","title":"1. Integrate the strong authentication into the primary system with and IdP","text":"<p>Authenticate a user at an identity provider certified for the Swiss EPR. Primary systems need to use this transaction to retrieve a IdP assertion. The IdP assertion is required to retrieve the XUA Assertion to be used with EPR transactions. See detailed description here.</p> <p>See EPRIK example for AuthnRequest and ArtifactResolve.</p> <p>If you have a test user you can use the IdP Assertion from EPRIK until you have done the IdP integration yourself.</p>"},{"location":"primarysystems-epr/#2-search-for-patients-in-the-community","title":"2. Search for patients in the community","text":"<p>This sequence diagram shows the preferred way of managing patient identities. The first case, EPR set in PS is the case where you have already linked your local patient identity to an EPR  patient identity and fed your local identifier to the MPI. To get the MPI-PID and the EPR-SPID, you just have to query the MPI with your local identifier (described in section  3.2).</p> <p>The second case, EPR not set in PS, is the case where you have to reconciliate the patient identities. You can query the MPI for patient demographics (like name, birthdate, gender, etc., described in section 2.2) and  manually match demographics. Once that is done, you can feed your patient local identifier to the MPI (described in section 3.1).</p>"},{"location":"primarysystems-epr/#21-check-if-the-patient-has-an-epr-based-on-ahvn13navs","title":"2.1 Check if the patient has an EPR based on AHVN13/NAVS","text":"<p>With the PIX V3 query You can use AHVN13/NAVS13 to check if the patient has an EPR (EPR-SPID is returned), and if the patient is already registered in the community (MPI-PID is returned). See example request for patient Gassmann, which returns EPR-SPID and MPI-PID in the id elements. For a test patient who has no EPR (as of 31.3.2023) with AHVN13 7560739410295 no EPR-SPID and MPI-PID is returned, see request. If the the AHVN13 is not found, an Application Error (AE) will be returned. For a test patient who has an EPR but not in CARA int (as of 31.3.2023) with AHVN13 7560520619845 only EPR-SPID is returned, see request.</p>"},{"location":"primarysystems-epr/#22-demographics-query","title":"2.2 Demographics Query","text":"<p>A search for a patient is done via a demographics query. See detailed description here.</p> <p>EPRIK example request, response. This example search is done on the family name, other demographics query parameters are possible. Please note that Swiss Extension requires that an error is returned if more than 5 matched would be returned. You need to provide creationTime, sender OID and receiver OID in addition to the query parameters in the request. For the communication you need a client certificate but with EPRIK a client certificate is not necessary.</p>"},{"location":"primarysystems-epr/#3-register-a-patient-from-the-primary-system-in-the-community-and-query-the-patient-community-id","title":"3. Register a patient from the primary system in the community and query the patient community id","text":""},{"location":"primarysystems-epr/#31-register-local-patient-id-in-the-community","title":"3.1 Register local patient Id in the community","text":"<p>Register a patient in a community. Primary systems need to use this transaction to register patient data and then to be able to provide and retrieve documents to the patients EPR. See detailed description here.</p> <p>EPRIK example request, response. This example registers the local id from the primary system P003 of the patient identity domain 2.16.756.5.30.1.145.1.3 in the MPI. You need to provide creationTime, sender OID and receiver OID in addition to the patient parameters ( EPR-SPID, MPI-ID) in the request. For the communication you need a client certificate, but with EPRIK a client certificate is not necessary.</p> <p>Danger</p> <p>Never feed a patient identifier with a domain that is not yours, and especially a domain equal to the configured receiver OID of the plateform. It would make the patient unreachable from PDQ queries.</p>"},{"location":"primarysystems-epr/#32-query-mpi-pid-and-epr-spid-based-on-local-id","title":"3.2 Query MPI-PID and EPR-SPID based on local ID","text":"<p>The primary systems needs to query the master patient ID (MPI-ID) for patients to retrieve or provide documents for, based on the local id registered above. See detailed description here.</p> <p>EPRIK example request, response.</p>"},{"location":"primarysystems-epr/#4-query-and-retrieve-documents-for-a-patient-from-the-epr","title":"4. Query and retrieve documents for a patient from the EPR","text":"<p>This sequence diagram shows the search and retrieval of documents. Searching documents in CARA is described in section 4.2a, searching in other communities is described in section 4.2b. Retrieving a document is described in sections 4.3a and 4.3b, depending on the community. The PIXv3 query is shown as a reminder. For these calls, another mandatory step is the Get X-User Assertion call to get a XUA token from the EPR.</p>"},{"location":"primarysystems-epr/#41-authorization","title":"4.1 Authorization","text":"<p>To query and retrieve documents the HCP needs to be authorized based on the IdP token, the patient (resourceID with EPR-SPID), purposeOfUse (NORM, EMER) and role (HCP). See detailed description here.</p> <p>EPRIK example request, response.</p> <p>Example STS requests with IdP or EPRIK-httpheader.</p>"},{"location":"primarysystems-epr/#42a-query-documents-from-the-cara-community","title":"4.2a Query documents from the CARA community","text":"<p>Retrieve the document metadata for the documents stored in a patients EPR for the CARA community. See detailed description here.</p> <p>EPRIK example request, response. For the Query the MPI-ID of the patient needs to be added. This example requests includes the security token necessary. With the EPRIK you can do the user authentication there and reuse the token see. For the communication you need a client certificate but with EPRIK a client certificate is not necessary.</p>"},{"location":"primarysystems-epr/#42b-query-documents-from-remote-communities","title":"4.2b Query documents from remote communities","text":"<p>To retrieve the document metadata for the documents stored in a patients EPR but registered in remote communities, the initiating gateway has to be called with an IIT-18 query. EPRIK example request, response. Gassmann has an example document in the remote community urn:oid:2.16.756.5.30.1.177.1.0.</p>"},{"location":"primarysystems-epr/#43a-retrieve-documents-from-the-cara-community","title":"4.3a Retrieve documents from the CARA community","text":"<p>To retrieve documents from a patients EPR the IHE XDS.b profile and transactions needs to be used. See detailed description here.</p> <p>EPRIK example request,response. With EPRIK you can do the user authentication there and reuse the token see. For the communication you need a client certificate but with EPRIK a client certificate is not necessary. You will need to add the HomeCommunityId, RepositoryUniqueId and DocumentUniqueId.</p>"},{"location":"primarysystems-epr/#43b-retrieve-documents-from-remote-communities","title":"4.3b Retrieve documents from remote communities","text":"<p>To retrieve the documents stored in remote communities, the initiating gateway has to be called with an ITI-43 query with the homeCommunityId added from result 4.2b. EPRIK example request, response.</p>"},{"location":"primarysystems-epr/#5-publish-documents-for-a-patient-by-a-healthcare-professional","title":"5. Publish documents for a patient by a healthcare professional","text":"<p>This sequence diagram shows the publication of a document by a healthcare professional.</p> <p>To provide documents and metadata about the documents the IHE XDS.b profile and transactions needs to be used. See detailed description here.</p> <p>EPRIK example request,response. With EPRIK you can do the user authentication there and reuse the token see. For the communication you need a client certificate but with EPRIK a client certificate is not necessary. You will need to add metadata for the document.</p>"},{"location":"primarysystems-epr/#confidentiality-code-in-metadata","title":"confidentiality code in metadata","text":"<p>The patient can set the default level of confidentiality to normally accessible , restricted accessible or secret. This need to be taken into account when publishing (sequence diagram). If a publication fails for normally accessible it has to be retried with restricted accessible. It is only possible to publish a document with confidentiality secret if the user has set the default confidentiality code to secret. To test this three different patients have been setup with different confidentiality codes: GASSMANN-IMHOLZ (normally accessible, EPR-SPID: 761337613645876216), SOARES JESUS (restricted accessible, EPR-SPID 761337616638768604) et Ratchawat (secret: EPR-SPID 761337610888245779)</p> Publication with normal restricted secret Gassmann (normally accessible) ok ok error SOARES JESUS (restricted accessible) error ok error Ratchawat (secret) error error ok"},{"location":"primarysystems-epr/#metadata-in-portal","title":"metadata in portal","text":"<p>The portal displays the metadata provided in the publication. The patient name is only visible if it is provided in PID-5 in sourcePatientInfo. example</p> <p>The institution can be filtered by the portal only if the <code>authorInstitution</code> contains an OID in the XON.10 field.</p>"},{"location":"primarysystems-epr/#provide-a-document-with-a-technical-user-tcu","title":"provide a document with a technical user (TCU)","text":"<p>This sequence diagram shows the publication of a document by a technical user.</p> <p>Instead of using an authenticated user for publishing documents, the ERP allows to publish documents with a technical user see factsheet in french. You are required to create a client certificate for this technical user and let it register in the HPD. See the developer platform for exact steps.</p> <p>EPRIK allows you to work with a specific test technical user during integration. You can get the TCU IdP SAML2 assertion from here. This assertion is valid for 10 minutes. With this assertion you can get then the XUA (STS) token for the XDS requests, for the urn:e-health-suisse:principal-id you need to put the GLN to 2000040030829 when using EPRIK's technical user. example</p>"},{"location":"primarysystems-epr/#change-metadata-of-existing-documents-2223","title":"change metadata of existing documents (2.223)","text":"<p>If a document has been added the metadata can be changed with the IHE Restricted Metadata Update Profile (RMU). See an example message here, where the document title is changed. A new ITI-18 query shows the changed title (Line 312). If you are working with a Technical User you would need to store the DocumentEntry including entryUUID during the provide and register transaction, because you cannot read it with ITI-18.</p>"},{"location":"primarysystems-epr/#replace-a-document","title":"Replace a document","text":"<p>To replace a document, the same ITI-41 transaction is used as for the publication of a new document, with the  addition of a specific <code>Association</code> element that shows which document is to be replaced:</p> <pre><code>&lt;rim:Association associationType=\"urn:ihe:iti:2007:AssociationType:RPLC\"\nsourceObject=\"urn:uuid:fa9b4f10-3ea1-436f-a988-ebbb8a2cfffc\"\ntargetObject=\"urn:uuid:42fbb7ad-fe7a-4585-95c6-15d91a476c40\"\nid=\"(a unique id)\"/&gt;\n</code></pre> <p>EPRIK example request,response.</p>"},{"location":"primarysystems-epr/#using-entryuuids","title":"Using entryUUIDs","text":"<p>Warning</p> <p>The documents entryUUIDs may change at any time: if the metadata changes (through an ITI-92 transaction, or if  the patient changes the confidentiality level), or if the document is replaced, a new entryUUID will be generated.</p> <p>To change the metadata of a document, or to replace it with a new document, the entryUUID of the currently approved  DocumentEntry is required, and may be different from the submitted entryUUID in the original publication. In some  cases, it may prove impossible to retrieve the right entryUUID. In those cases, the help from CARA's administrators  can be requested, or the document may be republished as a new document.</p> <p>To retrieve the currently approved entryUUID of a document that has not been replaced, if a healthcare professional  is logged in, the ITI-18 search can be used with the document unique ID. If a technical user is logged in, there is  no possibility. Depending on the configured confidentiality levels, the document may not be returned in the search.</p> <p>To retrieve the currently approved entryUUID of a document that has been replaced, the ITI-18 GetRelatedDocuments  search can be used to retrieve the document that replaced the original document. A loop may be needed, if the  document has been replaced multiple times.</p>"},{"location":"primarysystems-epr/#6-providing-auditevents","title":"6. Providing AuditEvents","text":"<p>Each IHE Transaction has AuditEvent requirements. This is described for each transaction (see example for ITI-45 here or in eprik). This AuditEvents need to be registered in the community. With EVSClient you can validate if the content of the AuditMessages is correct. See for sending message via syslog protocol also guidance about not using BOM in IHE 3.20.4.1.2 Message Semantics.</p> <p>The specifications for generating the audit messages are given in the following documents:</p> <ol> <li>DICOM PS3.15 A.5: the    foundation of audit messages.</li> <li>IHE profile for each transaction: in the section 'Security    Considerations' of each transaction, you'll find IHE requirements.</li> <li>EPDV-EDI Annex 5 Complement 1: there are some Swiss    requirements too. \u00a71.5.2 describes generic requirements and \u00a71.6.4.3.5.1 describes requirements for transactions    that use a SAML assertion (XUA).</li> </ol> <p>EPD-by-example has some examples of audit messages.</p>"},{"location":"primarysystems-epr/#7-query-and-modify-the-healthcare-professional-directory-hpd","title":"7. Query and modify the Healthcare Professional Directory (HPD)","text":"<p>The HPD is an LDAP directory, and interactions with it are wrapped in DSMLv2 objects. It contains three different objects: professionals (ou=HCProfessional), organizations (ou=HCRegulatedOrganization) and relationship between them (ou=Relationship).</p>"},{"location":"primarysystems-epr/#71-query-entries","title":"7.1 Query entries","text":"<p>With the ITI-58 transaction, you can query the Healthcare Professional Directory (HPD) for the entries you are interested in. You can query entries with LDAP filters on LDAP attributes and select the attributes to return. Example, request.</p>"},{"location":"primarysystems-epr/#72-add-an-entry","title":"7.2 Add an entry","text":"<p>With the ITI-59 transaction, you can add an entry to the HPD with an addRequest. Example, request.</p>"},{"location":"primarysystems-epr/#73-modify-an-entry","title":"7.3 Modify an entry","text":"<p>With the ITI-59 transaction, you can update an entry in the HPD with a modifyRequest. Example, request.</p>"},{"location":"primarysystems-epr/#74-delete-an-entry","title":"7.4 Delete an entry","text":"<p>With the ITI-59 transaction, you can delete an entry from the HPD with a delRequest. Example, request.</p>"},{"location":"primarysystems-epr/#8-oid-configuration","title":"8. OID Configuration","text":"Parameter Integration Production MPI OID Patient 2.16.756.5.30.1.191.1.0.2.1 2.16.756.5.30.1.191.3.0.2.1 HL7 v3 Receiver Device ID 2.16.756.5.30.1.191.1.0.12.1.101.2 2.16.756.5.30.1.191.3.0.12.1.101.2 Repository unique ID 2.16.756.5.30.1.191.1.0.12.1.101.31"},{"location":"requirements/","title":"CARA Requirements","text":"<p>There are some special requirements on top of the EPR, due to the software used by CARA.</p>"},{"location":"requirements/#when-publishing-a-document-iti-41","title":"When publishing a document (ITI-41)","text":"<p>The DocumentEntry.sourcePatientInfo SHALL be present and convey the patient first and last name in the PID-5 field. This information is used by the web portal to show the patient name associated with that document. You can provide the name as found in the MPI.</p> <p>Other PID fields are optional.</p> <pre><code>&lt;Slot name=\"sourcePatientInfo\"&gt;\n&lt;ValueList&gt;\n&lt;Value&gt;PID-5|GASSMANN-IMHOLZ^CYRIL RENE FRANCOIS&lt;/Value&gt;\n&lt;/ValueList&gt;\n&lt;/Slot&gt;\n</code></pre> <p>If using the <code>authorInstitution</code> attribute, the HL7 V2.5 XON value SHALL contain the organization OID in the XON.10 field.</p> <pre><code>&lt;rim:Value&gt;Some Hospital^^^^^^^^^2.999.1.2.3.4.5.6.7.8.9.1789.45&lt;/rim:Value&gt;\n</code></pre>"},{"location":"testpatients/","title":"Testpatients","text":""},{"location":"testpatients/#test-patients","title":"Test Patients","text":"<p>The following test patients are setup for the integration systems to test publication as health professional. For retrieval you will need to ask the integration community that you get read access for the patients for your health professional.</p>"},{"location":"testpatients/#test-patients-with-cara-as-home-community","title":"Test patients with CARA as home community","text":"FirstName LastName DateOfBirth Gender SSN Comment Marion Jeanne Suzanne SOARES JESUS 25.05.1970 F 7560644233163 restricted default conf code CHRISTA LUZIA Ratchawat 11.10.1994 F 7560644214162 secret default conf code Kit Hung Elshani Aloci 27.09.2014 F 7560644765176 Dave Mathew Sarita Samuel 08.03.1984 M 7560644871280 Jannis Leonard FAVRE-JEANMONOD 11.02.2004 M 7560644892179 BRICE ROLAND LETTIERI-SERRA 16.01.1968 M 7560644981064 Cedric Maxime RAMOS ROGERIO 03.04.1978 M 7560644987394 WINIFRED Widmer-Zirm 04.03.2010 F 7560645085549 Jean-Philipp Michael Sutter-Rickenbacher 30.05.1991 M 7560645272765 STACY MARCIA AVDIJA-JASHARI 05.01.1971 F 7560645284416 Shukrullah MEIER-TUERK 15.02.1972 M 7560645346817 LOUIS DOMINIC ATAMBOTO LOMO 28.06.1985 M 7560645355383 CYRIL RENE FRANCOIS GASSMANN-IMHOLZ normal default conf code, currently broken, use another (as of 12.10.23)"},{"location":"testpatients/#test-patients-with-a-different-home-community","title":"Test patients with a different home community","text":"FirstName LastName DateOfBirth Gender SSN Comment MARCIA-APARECIDA STRASSER-BAER 15.09.1988 F 7560410146567 MDS Olivier Roger SHKODRA-VESELI 17.02.1976 M 7560410179848 MDS Oliver Artiom KUEHNI-TRAN 22.04.1974 M 7560410199921 MDS Anthony Th\u00e9ophile Walther Bl\u00f6chlinger-Ernst 18.01.2009 M 7560410212903 MDS MELINDA SOPHIE LUSTENBERGER-BAER 03.10.1985 F 7560615781303 SteHAG ALVIN CHRISTOPH Hoxha-Lamaxhema 17.02.1977 M 7560615860077 SteHAG"},{"location":"transferts/","title":"transferts (tra)","text":"<p>With the document transfer service of CARA (transferts (tra)) the following use cases are supported:</p> <ul> <li>A primary system submits medical documents to CARA addressing it to the desired recipient healthcare professional (   HCP).</li> <li>CARA notifies subscribed HCPs that a primary system transferred a new medical document to her/ him.</li> <li>The HCP can access the portal and view the received medical document. Additionally, CARA delivers the medical document   to subscribed HCPs by email. Primary system can retrieve via web service all those transferred documents for the   specific user.</li> </ul> <p>Authentication between primary systems and CARA endpoints is done via client certificate TLS mutual authentication. The HCP must provide this client certificate including the certificate chain (.pem format, unprotected, base64, x509) and let it register by CARA. The HCPs GLN must be part of this certificate.</p> <p>Retrieval of medical documents requires an authorization token (SAML assertion). The assertion must be requested by the system from the B2B STS with the client certificate containing the GLN. The assertion validity period of the B2B STS is 15 minutes.</p> <p>The integration system is can be found here.</p>"},{"location":"transferts/#transactions","title":"Transactions","text":"<ul> <li>104 \u2013 Request Security Token: To authenticate and extract the SAML assertion.</li> <li>100 - PIXV3 Query (ITI-45): To search for a patient in the Master Patient Index with their AHV number and    retrieve their identifiers if they are already known in the CARA B2B platform (optional).</li> <li>102 \u2013 Provider Information Query (ITI-58): To search for the recipient(s) of the documents to exchange in the    Healthcare Provider Directory.</li> <li>106 \u2013 submitDocuments: To send the document(s) to the recipient(s).</li> <li>200 \u2013 GetDocumentList: To retrieve the list of documents to download as a recipient.</li> <li>202 \u2013 Registry Stored Query (ITI-18): To retrieve the document metadata from the XDS registry.</li> <li>204 \u2013 Retrieve Document Set (ITI-43): To retrieve the document from the XDS repository.</li> <li>206 \u2013 DeleteDocumentList: To delete the document(s) from the recipient's document list.</li> </ul>"},{"location":"transferts/#eprik-integration-with-transferts-tra","title":"eprik integration with transferts (tra)","text":"<p>EPRIK supports the development during the integration with the predefined HCP 2000040030829 configured that the primary systems can use the transaction without authentication / authorization.</p> <ol> <li>An authorization token can be received for HCP    2000040030829 request</li> <li>Send a document with HCP 2000040030829 as recipient and    sender request</li> <li>Receive the document list for HCP    2000040030829 request</li> <li>Download the document for HCP    2000040030829 request</li> <li>Delete a document for HCP    2000040030829 request (    TODO: update after transaction name has been added)</li> </ol>"},{"location":"usecases/","title":"EPRIK Usecases","text":"<p>The EPRIK can help you speed up or test the development against the integration system:</p> <ol> <li>Use http(s) endpoints without the need to use client certificates</li> <li>Proxy functionality: See directly what you are sending to the integration system and receiving, including basic    validation, this is available for SOAP webservices and ATNA Audit Events</li> <li>Use the IdP Assertion from EPRIK that you can get a XUA token from the STS (secure token service) to do document    queries or publish documents</li> <li>Use the TCU Assertion from EPRIK that you can get a XUA token from the STS (secure token service) to publish a    document via a technical user</li> </ol>"},{"location":"usecases/#https-endpoints-without-the-need-to-use-client-certificates-and-proxy-functionality","title":"http(s) endpoints without the need to use client certificates and proxy functionality","text":"<p>Adapt your webservice endpoints to the one provided in [eprik-config.md]. This allows you to use http or https endpoints without the need to use client certificates from the beginning and you can verify the if the different webservices are working.</p> <p>To execute the examples you can either use curl or use the provided .http files if you have VSCode with the REST Client extension installed.</p> <p>Demographics Query for GASSMANN:</p> <pre><code>curl --request POST \\\n--url https://test.ahdis.ch/eprik-cara/camel/cara/UPIProxy/services/PIXPDQV3ManagerService \\\n--header 'content-type: application/soap+xml;charset=UTF-8' \\\n--header 'user-agent: vscode-restclient' \\\n--data '&lt;soap:Envelope xmlns:soap=\"http://www.w3.org/2003/05/soap-envelope\"&gt;&lt;soap:Header&gt;&lt;Action soap:mustUnderstand=\"true\" xmlns=\"http://www.w3.org/2005/08/addressing\"&gt;urn:hl7-org:v3:PRPA_IN201305UV02&lt;/Action&gt;&lt;MessageID xmlns=\"http://www.w3.org/2005/08/addressing\"&gt;urn:uuid:88c76963-f467-49e2-a2c0-a772a4685ee3&lt;/MessageID&gt;&lt;To xmlns=\"http://www.w3.org/2005/08/addressing\"&gt;http://test.ahdis.ch/eprik-cara/services/iti47Endpoint&lt;/To&gt;&lt;ReplyTo xmlns=\"http://www.w3.org/2005/08/addressing\"&gt;&lt;Address&gt;http://www.w3.org/2005/08/addressing/anonymous&lt;/Address&gt;&lt;/ReplyTo&gt;&lt;/soap:Header&gt;&lt;soap:Body&gt;&lt;PRPA_IN201305UV02 xmlns=\"urn:hl7-org:v3\" ITSVersion=\"XML_1.0\"&gt;&lt;id extension=\"1659464609650\" root=\"1.3.6.1.4.1.21367.2017.2.1.104\"/&gt;&lt;creationTime value=\"20220822083241\"/&gt;&lt;interactionId extension=\"PRPA_IN201305UV02\" root=\"2.16.840.1.113883.1.6\"/&gt;&lt;processingCode code=\"T\"/&gt;&lt;processingModeCode code=\"T\"/&gt;&lt;acceptAckCode code=\"AL\"/&gt;&lt;receiver typeCode=\"RCV\"&gt;&lt;device classCode=\"DEV\" determinerCode=\"INSTANCE\"&gt;&lt;id root=\"2.16.756.5.30.1.191.1.0.12.1.101.2\"/&gt;&lt;/device&gt;&lt;/receiver&gt;&lt;sender typeCode=\"SND\"&gt;&lt;device classCode=\"DEV\" determinerCode=\"INSTANCE\"&gt;&lt;id root=\"2.16.756.5.30.1.196.3.2.1\"/&gt;&lt;/device&gt;&lt;/sender&gt;&lt;controlActProcess classCode=\"CACT\" moodCode=\"EVN\"&gt;&lt;code code=\"PRPA_TE201305UV02\" displayName=\"2.16.840.1.113883.1.6\"/&gt;&lt;queryByParameter&gt;&lt;queryId extension=\"1659464609651\" root=\"1.3.6.1.4.1.21367.2017.2.1.104\"/&gt;&lt;statusCode code=\"new\"/&gt;&lt;responseModalityCode code=\"R\"/&gt;&lt;responsePriorityCode code=\"I\"/&gt;&lt;parameterList&gt;&lt;livingSubjectName&gt;&lt;value use=\"SRCH\"&gt;&lt;family&gt;GASSMANN&lt;/family&gt;&lt;/value&gt;&lt;semanticsText&gt;LivingSubject.name&lt;/semanticsText&gt;&lt;/livingSubjectName&gt;&lt;/parameterList&gt;&lt;/queryByParameter&gt;&lt;/controlActProcess&gt;&lt;/PRPA_IN201305UV02&gt;&lt;/soap:Body&gt;&lt;/soap:Envelope&gt;'\n</code></pre>"},{"location":"usecases/#proxy-functionality","title":"Proxy functionality","text":"<p>You can then search for the request on eprik-cara, it shows ALL requests/responses which happened today. You can also adjust the filter criteria. If you click on 'show' you see the details of the request:</p> <p></p> <p>If you click on 'format XML' it will pretty print the request / response (do not this for assertions which are signed when you wan't to reuse them). If you click on the 'Response' tab you get the response message. If an Assertion was provided you would see it in the 'Assertion tab'. If the request failed internally you will see additional information in the 'Runtime Exception' tab. The status 'Response valid' is the EPRIK internal validation of the request, it does not guarantee that the request is correct and accepted by the CARA integration system.</p>"},{"location":"usecases/#proxy-atna-messages","title":"proxy ATNA messages","text":"<p>EPRIK offers an endpoint for unauthenticated transport receiver and sender according to rfc5425. The protocol requires that message length is sent first and then the other syslog parameters defined by ITI-20, see example.</p> <pre><code>2164 &lt;85&gt;1 2023-04-18T09:04:00.603Z matchbox.test - - IHE+RFC-3881 - &lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;&lt;AuditMessage&gt; ...\n</code></pre> <p>with netcat the above message can be directly sent to eprik:</p> <pre><code>nc -w1 -v atna.test.ahdis.ch 8080 &lt; ./docs/requests/iti-47-atna-raw.txt </code></pre> <p>and is afterwards visible in eprik-cara atna example, see tab \"headers\" for detailed syslog protocol information.</p>"},{"location":"usecases/#use-the-idp-assertion-from-eprik","title":"Use the IdP Assertion from EPRIK","text":"<p>For document access you need to have an assertion which is based on a IdP token. EPRKIT allows you to get the IdP assertion which you can use for retrieving the SAML2 assertion token if your primary system is not integrated yet with the IdP.</p> <p>Authenticate with your Identity Provider on the top right. If you are authenticated successfully you can add either add the IdP Token directly to your request or reference it it via the HTTP header (replace x-eprik-idp-assertion-id with value received after authenticating).</p> <p>reference IdP Token with HTTP header:</p> <pre><code>curl --request POST \\\n--url https://test.ahdis.ch/eprik-cara/camel/cara/STS/services/SecurityTokenService \\\n--header 'content-type: application/soap+xml;charset=UTF-8' \\\n--header 'user-agent: vscode-restclient' \\\n--header 'x-eprik-idp-assertion-id: 4790' \\\n--data '&lt;env:Envelope xmlns:env=\"http://www.w3.org/2003/05/soap-envelope\"&gt;&lt;env:Header xmlns:wsa=\"http://www.w3.org/2005/08/addressing\"&gt;&lt;wsa:Action&gt;http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Issue&lt;/wsa:Action&gt;&lt;wsa:MessageID&gt;6ed3440a-0164-49c4-b9d2-235422819e90&lt;/wsa:MessageID&gt;&lt;wsse:Security xmlns:wsse=\"http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd\"&gt;&lt;/wsse:Security&gt;&lt;/env:Header&gt;&lt;env:Body&gt;&lt;wst:RequestSecurityToken xmlns:wst=\"http://docs.oasis-open.org/ws-sx/ws-trust/200512\"&gt;&lt;wst:RequestType&gt;http://docs.oasis-open.org/ws-sx/ws-trust/200512/Issue&lt;/wst:RequestType&gt;&lt;wsp:AppliesTo xmlns:wsp=\"http://schemas.xmlsoap.org/ws/2004/09/policy\"&gt;&lt;wsa:EndpointReference xmlns:wsa=\"http://www.w3.org/2005/08/addressing\"&gt;&lt;wsa:Address&gt;https://test.ahdis.ch/mag-cara&lt;/wsa:Address&gt;&lt;/wsa:EndpointReference&gt;&lt;/wsp:AppliesTo&gt;&lt;wst:TokenType&gt;http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV2.0&lt;/wst:TokenType&gt;&lt;wst:Claims Dialect=\"http://www.bag.admin.ch/epr/2017/annex/5/amendment/2\"&gt;&lt;saml2:Attribute xmlns:saml2=\"urn:oasis:names:tc:SAML:2.0:assertion\" Name=\"urn:oasis:names:tc:xacml:2.0:resource:resource-id\"&gt;&lt;saml2:AttributeValue xmlns:xs=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\"&gt;761337613645876216^^^&amp;amp;2.16.756.5.30.1.127.3.10.3&amp;amp;ISO&lt;/saml2:AttributeValue&gt;&lt;/saml2:Attribute&gt;&lt;saml2:Attribute xmlns:saml2=\"urn:oasis:names:tc:SAML:2.0:assertion\" Name=\"urn:oasis:names:tc:xspa:1.0:subject:purposeofuse\"&gt;&lt;saml2:AttributeValue xmlns:xs=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:anyType\"&gt;&lt;PurposeOfUse xmlns=\"urn:hl7-org:v3\" code=\"NORM\" codeSystem=\"2.16.756.5.30.1.127.3.10.5\" codeSystemName=\"eHealth Suisse Verwendungszweck\" displayName=\"Normal Access\" xsi:type=\"CE\"/&gt;&lt;/saml2:AttributeValue&gt;&lt;/saml2:Attribute&gt;&lt;saml2:Attribute xmlns:saml2=\"urn:oasis:names:tc:SAML:2.0:assertion\" Name=\"urn:oasis:names:tc:xacml:2.0:subject:role\" NameFormat=\"urn:oasis:names:tc:SAML:2.0:attrname-format:unspecified\"&gt;&lt;saml2:AttributeValue xmlns:xs=\"http://www.w3.org/2001/XMLSchema\"&gt;&lt;Role xmlns=\"urn:hl7-org:v3\" code=\"HCP\" codeSystem=\"2.16.756.5.30.1.127.3.10.6\" codeSystemName=\"eHealth Suisse EPR Akteure\" displayName=\"Healthcare professional\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"CE\"/&gt;&lt;/saml2:AttributeValue&gt;&lt;/saml2:Attribute&gt;&lt;/wst:Claims&gt;&lt;/wst:RequestSecurityToken&gt;&lt;/env:Body&gt;&lt;/env:Envelope&gt;'\n</code></pre> <p>Danger</p> <p>The IdP Token is  valid only for 5 minutes, and you will have to close / reopen the browser, otherwise you will get back the same token which is not valid anymore for the STS</p>"},{"location":"img/","title":"Index","text":"<p>The SVG images here can be loaded and modified in https://app.diagrams.net/.</p>"}]}